<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ImageCraft Pro | Premium Image Converter</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#4361ee;
      --primary-dark:#3a56d4;
      --surface:#ffffff;
      --bg:#f6f7fb;
      --text:#1e2a4a;
      --muted:#667085;
      --border:#e6e8ef;
      --radius:14px;
      --shadow:0 10px 30px rgba(17, 24, 39, .08);
      --shadow-sm:0 6px 18px rgba(17, 24, 39, .06);
      --container:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 100% -50%, #eaf0ff 10%, transparent 40%),
        radial-gradient(1000px 500px at -20% 0%, #f2f6ff 10%, transparent 50%),
        var(--bg);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:var(--container);margin-inline:auto;padding-inline:20px}

    /* Header */
    header{
      position:sticky;top:0;z-index:1000;background:rgba(255,255,255,.88);
      backdrop-filter:saturate(140%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .header-wrap{
      display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 0;
    }
    .logo{display:flex;align-items:center;gap:10px;color:var(--primary);font-weight:700}
    .logo i{font-size:26px}
    nav ul{display:flex;gap:28px;list-style:none;margin:0;padding:0}
    nav a{
      color:var(--text);text-decoration:none;font-weight:500;position:relative;padding:6px 0;
    }
    nav a:after{
      content:"";position:absolute;left:0;bottom:-6px;height:2px;width:0;background:var(--primary);
      transition:width .2s ease;
    }
    nav a:hover{color:var(--primary)}
    nav a:hover:after{width:100%}
    .nav-cta{
      display:inline-flex;align-items:center;gap:8px;color:#fff;background:var(--primary);
      padding:10px 16px;border-radius:999px;border:1px solid var(--primary-dark);text-decoration:none;
      box-shadow:var(--shadow-sm);
    }
    .nav-cta:hover{background:var(--primary-dark)}

    /* Hamburger (accessible) */
    .hamburger{
      display:none;appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;
      width:44px;height:44px;align-items:center;justify-content:center;color:var(--text);
      box-shadow:var(--shadow-sm);
    }
    .hamburger:focus-visible{outline:2px solid var(--primary);outline-offset:2px}

    /* Mobile panel */
    .overlay{
      position:fixed;inset:0;background:rgba(2,6,23,.5);opacity:0;visibility:hidden;transition:.2s;
      z-index:999;
    }
    .overlay.active{opacity:1;visibility:visible}
    .mobile-nav{
      position:fixed;top:0;right:-100%;height:100%;width:min(85%,380px);
      background:#fff;z-index:1000;box-shadow:-8px 0 30px rgba(2,6,23,.2);
      transition:right .25s ease;display:flex;flex-direction:column;padding:84px 24px 24px;
    }
    .mobile-nav.active{right:0}
    .mobile-nav .close{
      position:absolute;top:18px;right:18px;border:none;background:#fff;border:1px solid var(--border);
      width:40px;height:40px;border-radius:10px;display:grid;place-items:center;
    }
    .mobile-nav nav ul{flex-direction:column;gap:4px}
    .mobile-nav nav a{display:block;padding:12px 0;border-bottom:1px dashed var(--border)}

    /* Hero */
    .hero{padding:56px 0 20px;text-align:center}
    .hero h1{
      font-size:clamp(28px, 4.2vw, 48px);line-height:1.15;margin:6px 0 12px;color:#111827;
    }
    .hero p{max-width:740px;margin:0 auto 26px;color:var(--muted);font-size:clamp(15px,2.2vw,18px)}

    /* Converter */
    .converter{
      background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:26px;
      max-width:900px;margin:0 auto 22px;border:1px solid var(--border);
    }
    .drop{
      border:2px dashed #d5dbef;border-radius:var(--radius);padding:34px 16px;text-align:center;
      transition:.2s;cursor:pointer;background:#fbfcff;
    }
    .drop:hover{border-color:var(--primary);background:#f6f8ff}
    .drop i{font-size:46px;color:var(--primary);margin-bottom:8px}
    .btn{
      display:inline-flex;align-items:center;gap:10px;border:none;border-radius:999px;
      padding:12px 20px;font-weight:600;cursor:pointer;transition:.2s;
    }
    .btn-primary{background:var(--primary);color:#fff;border:1px solid var(--primary-dark)}
    .btn-primary:hover{background:var(--primary-dark)}
    .btn-outline{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .btn-muted{background:#e7e9f3;color:#334155;border:1px solid #d7dbe8;cursor:not-allowed}
    .btn-icon{gap:8px}

    .sections{margin-top:24px}
    .row{display:flex;gap:24px;flex-wrap:wrap}
    .col{flex:1 1 280px}

    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow-sm)}
    .preview{
      width:100%;max-height:340px;object-fit:contain;border-radius:12px;border:1px solid var(--border);
      background:#fafbff;
    }
    .meta{margin-top:10px;font-size:14px;color:#374151}
    .meta p{display:flex;justify-content:space-between;margin:6px 0}
    .meta span{font-weight:600;color:#111827}

    .formats{
      display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;margin:14px 0 6px;
    }
    .format{
      border:1.5px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer;
      transition:.2s;background:#fff;
    }
    .format:hover{transform:translateY(-2px);box-shadow:var(--shadow-sm);border-color:#d3d8eb}
    .format.active{border-color:var(--primary);box-shadow:0 0 0 3px rgba(67,97,238,.12)}
    .format small{display:block;margin-top:6px;color:var(--muted);font-size:12px}

    .controls{display:grid;grid-template-columns:1fr;gap:12px;margin:8px 0 6px}
    .control{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .control input[type="range"]{width:60%}

    .progress{display:none;margin-top:10px}
    .progressbar-wrap{height:10px;background:#eef1f8;border-radius:6px;overflow:hidden}
    .progressbar{height:100%;width:0;background:linear-gradient(90deg,var(--primary),#7b91ff)}

    .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:8px}

    /* Ads (kept minimal) */
    .ad{display:flex;align-items:center;justify-content:center;min-height:110px;background:#f8fafc;
      border:1px dashed #dbe1f2;border-radius:12px;color:#64748b}

    /* Footer */
    footer{margin-top:60px;background:#0f172a;color:#d1d5db}
    .footer-inner{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:28px;padding:36px 0}
    footer a{color:#cbd5e1;text-decoration:none}
    footer a:hover{color:#fff}
    .copyright{border-top:1px solid rgba(255,255,255,.1);padding:16px 0;color:#94a3b8;text-align:center}

    /* Responsive tweaks */
    @media (max-width: 860px){
      nav ul{display:none}
      .hamburger{display:inline-flex}
      .hero{padding-top:36px}
    }
  </style>
</head>
<body>
  <!-- Overlay + Mobile Nav -->
  <div class="overlay" id="overlay" aria-hidden="true"></div>
  <aside class="mobile-nav" id="mobileNav" aria-hidden="true" aria-label="Mobile">
    <button class="close" id="closeMenu" aria-label="Close menu">
      <i class="fas fa-times"></i>
    </button>
    <nav aria-label="Mobile main">
      <ul>
        <li><a href="#">Home</a></li>
        <li><a href="#">Tools</a></li>
        <li><a href="#">Pricing</a></li>
        <li><a href="#">Contact</a></li>
        <li><a class="nav-cta" href="#"><i class="fas fa-rocket"></i> Get Started</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Header -->
  <header>
    <div class="container header-wrap">
      <div class="logo"><i class="fas fa-image"></i><span>ImageCraft Pro</span></div>

      <nav aria-label="Main">
        <ul>
          <li><a href="#">Home</a></li>
          <li><a href="#">Tools</a></li>
          <li><a href="#">Pricing</a></li>
          <li><a href="#">Contact</a></li>
          <li><a class="nav-cta" href="#"><i class="fas fa-rocket"></i> Get Started</a></li>
        </ul>
      </nav>

      <button class="hamburger" id="hamburger"
              aria-label="Open menu" aria-controls="mobileNav" aria-expanded="false">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero container">
    <h1>Convert images <span style="color:var(--primary)">the right way</span></h1>
    <p>Instant, private, and accurate format conversion in the browser—no fake fallbacks, no uploads, just real output formats selected with confidence.</p>
  </section>

  <!-- Converter -->
  <main class="container">
    <div class="converter" id="converter">
      <!-- Upload -->
      <div class="drop" id="drop">
        <i class="fas fa-cloud-upload-alt"></i>
        <h3>Drag & drop an image</h3>
        <p style="color:var(--muted);margin:6px 0 12px">or</p>
        <input type="file" id="file" accept="image/*" hidden>
        <button class="btn btn-primary btn-icon" id="browse"><i class="fas fa-folder-open"></i> Browse files</button>
      </div>

      <section class="sections" id="sections" hidden>
        <!-- Original -->
        <div class="row">
          <div class="col">
            <div class="card">
              <h3 style="margin:0 0 10px">Original</h3>
              <img id="prevOriginal" alt="Original preview" class="preview" />
              <div class="meta" id="infoOriginal"></div>
            </div>
          </div>

          <!-- Settings -->
          <div class="col">
            <div class="card">
              <h3 style="margin:0 0 8px">Select output</h3>
              <div id="formatGrid" class="formats" role="listbox" aria-label="Formats">
                <!-- Formats populate via JS to reflect encoder availability -->
              </div>

              <div class="controls">
                <div class="control">
                  <label for="quality"><strong>Quality</strong></label>
                  <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.9">
                </div>
              </div>

              <div class="actions">
                <button class="btn btn-primary btn-icon" id="convert" disabled>
                  <i class="fas fa-cog"></i> Convert
                </button>
                <button class="btn btn-outline btn-icon" id="newImage">
                  <i class="fas fa-redo"></i> New Image
                </button>
              </div>

              <div class="progress" id="progressWrap" aria-live="polite">
                <div class="progressbar-wrap" aria-hidden="true">
                  <div class="progressbar" id="progressBar"></div>
                </div>
                <p id="progressText" class="meta" style="margin:8px 0 0;color:var(--muted)">Preparing…</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Result -->
        <div class="row" id="resultRow" hidden>
          <div class="col">
            <div class="card">
              <h3 style="margin:0 0 10px">Converted</h3>
              <img id="prevConverted" alt="Converted preview" class="preview" />
              <div class="meta" id="infoConverted"></div>
              <div class="actions">
                <button class="btn btn-primary btn-icon" id="download">
                  <i class="fas fa-download"></i> Download
                </button>
                <button class="btn btn-outline btn-icon" id="another">
                  <i class="fas fa-wand-magic-sparkles"></i> New Conversion
                </button>
              </div>
            </div>
          </div>
          <div class="col ad">
            <div>
              <p style="margin:0 0 4px">Upgrade to speed up heavy codecs</p>
              <small>Enable AVIF/HEIC via lightweight WASM bundles</small>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Minimal ad strip -->
    <div class="ad" style="margin-top:18px">
      Premium batch conversion • No tracking • Edge codecs
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container footer-inner">
      <div>
        <h3 style="margin-top:0;color:#fff">ImageCraft Pro</h3>
        <p>Professional, private, in‑browser image conversions.</p>
      </div>
      <div>
        <h4 style="color:#fff;margin:0 0 8px">Tools</h4>
        <ul style="list-style:none;margin:0;padding:0;display:grid;gap:8px">
          <li><a href="#">JPEG ↔ PNG</a></li>
          <li><a href="#">WebP Converter</a></li>
          <li><a href="#">GIF/TIFF (encoders)</a></li>
        </ul>
      </div>
      <div>
        <h4 style="color:#fff;margin:0 0 8px">Company</h4>
        <ul style="list-style:none;margin:0;padding:0;display:grid;gap:8px">
          <li><a href="#">About</a></li>
          <li><a href="#">Pricing</a></li>
          <li><a href="#">Privacy</a></li>
        </ul>
      </div>
      <div>
        <h4 style="color:#fff;margin:0 0 8px">Support</h4>
        <ul style="list-style:none;margin:0;padding:0;display:grid;gap:8px">
          <li><a href="#">Help Center</a></li>
          <li><a href="#">FAQ</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </div>
    </div>
    <div class="copyright">
      <p>© 2025 ImageCraft Pro. All rights reserved.</p>
    </div>
  </footer>

  <!-- OPTIONAL ENCODERS
    To enable true GIF and/or true TIFF output, load encoders before main script:
    - GIF: a browser GIF encoder exposing `window.GIF` or `window.GIFEncoder`
    - TIFF: a browser TIFF encoder exposing `window.UTIF` with encodeImage()
    Keep their worker files next to the script if required by the encoder.
  -->

  <script>
  (function(){
    // Elements
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const browse = document.getElementById('browse');
    const sections = document.getElementById('sections');

    const prevOriginal = document.getElementById('prevOriginal');
    const infoOriginal = document.getElementById('infoOriginal');
    const prevConverted = document.getElementById('prevConverted');
    const infoConverted = document.getElementById('infoConverted');

    const formatGrid = document.getElementById('formatGrid');
    const quality = document.getElementById('quality');
    const convertBtn = document.getElementById('convert');
    const newImageBtn = document.getElementById('newImage');

    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultRow = document.getElementById('resultRow');
    const downloadBtn = document.getElementById('download');
    const anotherBtn = document.getElementById('another');

    const overlay = document.getElementById('overlay');
    const mobileNav = document.getElementById('mobileNav');
    const hamburger = document.getElementById('hamburger');
    const closeMenu = document.getElementById('closeMenu');

    // State
    let originalFile = null;
    let originalBitmap = null;
    let originalDataUrl = '';
    let convertedBlob = null;
    let convertedMime = '';
    let convertedName = '';
    let selectedFormat = null;

    // Detect format capabilities
    const canEncode = {
      jpeg: true, // via canvas
      png: true,  // via canvas
      webp: true, // widely supported; will check MIME echo at runtime
      bmp: true,  // custom encoder below
      gif: !!(window.GIF || window.GIFEncoder), // optional
      tiff: !!(window.UTIF && window.UTIF.encodeImage) // optional
    };

    const FORMAT_LABELS = {
      jpeg: 'JPEG',
      png: 'PNG',
      webp: 'WebP',
      bmp: 'BMP',
      gif: 'GIF',
      tiff: 'TIFF'
    };

    const LOSSY = new Set(['jpeg','webp']);

    // Build format grid according to capability
    const order = ['jpeg','png','webp','bmp','gif','tiff'];
    for(const fmt of order){
      const enabled = canEncode[fmt];
      const el = document.createElement('button');
      el.className = 'format';
      el.type = 'button';
      el.setAttribute('role','option');
      el.dataset.format = fmt;
      el.innerHTML = `
        <i class="fas fa-file-image" style="color:var(--primary);font-size:22px"></i>
        <div style="margin-top:6px;font-weight:600">${FORMAT_LABELS[fmt]}</div>
        ${enabled ? '' : '<small>encoder required</small>'}
      `;
      if(!enabled){
        el.disabled = true;
        el.style.opacity = .6;
        el.style.cursor = 'not-allowed';
      }
      formatGrid.appendChild(el);
    }

    // Select format
    formatGrid.addEventListener('click', (e)=>{
      const btn = e.target.closest('.format');
      if(!btn || btn.disabled) return;
      [...formatGrid.children].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      selectedFormat = btn.dataset.format;
      convertBtn.disabled = false;
      convertBtn.classList.remove('btn-muted');
      // Toggle quality slider for lossy codecs only
      document.querySelector('.controls').style.display = LOSSY.has(selectedFormat) ? 'grid' : 'none';
    });

    // Accessible mobile menu
    hamburger.addEventListener('click', ()=>{
      mobileNav.classList.add('active');
      overlay.classList.add('active');
      mobileNav.setAttribute('aria-hidden','false');
      hamburger.setAttribute('aria-expanded','true');
      document.body.style.overflow='hidden';
      // move focus to close button
      setTimeout(()=>closeMenu.focus(), 10);
    });
    function closePanel(){
      mobileNav.classList.remove('active');
      overlay.classList.remove('active');
      mobileNav.setAttribute('aria-hidden','true');
      hamburger.setAttribute('aria-expanded','false');
      document.body.style.overflow='auto';
      hamburger.focus();
    }
    overlay.addEventListener('click', closePanel);
    closeMenu.addEventListener('click', closePanel);
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && mobileNav.classList.contains('active')) closePanel();
    });

    // Upload handlers
    browse.addEventListener('click', ()=>fileInput.click());
    drop.addEventListener('dragover', (e)=>{e.preventDefault(); drop.style.borderColor='var(--primary)'});
    drop.addEventListener('dragleave', ()=>{drop.style.borderColor='#d5dbef'});
    drop.addEventListener('drop', (e)=>{
      e.preventDefault();
      if(e.dataTransfer.files?.) handleFile(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e)=>{
      if(e.target.files?.) handleFile(e.target.files);
    });

    newImageBtn.addEventListener('click', resetAll);
    anotherBtn?.addEventListener('click', ()=>{
      resultRow.hidden = true;
      convertedBlob = null;
      convertedMime = '';
      convertedName = '';
      [...formatGrid.children].forEach(b=>b.classList.remove('active'));
      selectedFormat = null;
      convertBtn.disabled = true;
      convertBtn.classList.add('btn-muted');
      progress(0,false);
      prevConverted.removeAttribute('src');
      infoConverted.innerHTML='';
      window.scrollTo({top: converter.offsetTop - 20, behavior:'smooth'});
    });

    // Convert
    convertBtn.addEventListener('click', async ()=>{
      if(!originalBitmap || !selectedFormat) return;
      progress(10,true,'Converting…');

      try{
        const blob = await convertBitmap(originalBitmap, selectedFormat, Number(quality.value));
        convertedBlob = blob;
        convertedMime = blob.type || guessMime(selectedFormat);
        convertedName = getBaseName(originalFile?.name || 'image') + '.' + extForMime(convertedMime, selectedFormat);

        const url = URL.createObjectURL(blob);
        prevConverted.src = url;
        infoConverted.innerHTML = fileInfo(convertedName, convertedMime, blob.size);

        progress(100,false,'Done');
        resultRow.hidden = false;
        resultRow.scrollIntoView({behavior:'smooth', block:'start'});
      }catch(err){
        progress(0,false);
        alert(err?.message || 'Conversion failed.');
      }
    });

    downloadBtn.addEventListener('click', ()=>{
      if(!convertedBlob) return;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(convertedBlob);
      a.download = convertedName || 'output';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    });

    // Helpers
    async function handleFile(file){
      if(!file.type.startsWith('image/')){ alert('Please select an image file.'); return; }
      resetAll();

      originalFile = file;
      const dataUrl = await readAsDataURL(file);
      originalDataUrl = dataUrl;

      // Prefer createImageBitmap for efficient decode
      originalBitmap = await createImageBitmap(file);

      // Show preview & info
      prevOriginal.src = dataUrl;
      infoOriginal.innerHTML = fileInfo(file.name, file.type, file.size);

      sections.hidden = false;
      drop.hidden = true;
      window.scrollTo({top: sections.offsetTop - 8, behavior:'smooth'});
    }

    function resetAll(){
      // state
      originalFile = null;
      originalBitmap?.close?.();
      originalBitmap = null;
      originalDataUrl = '';
      convertedBlob = null;
      convertedMime = '';
      convertedName = '';
      selectedFormat = null;
      // ui
      fileInput.value = '';
      prevOriginal.removeAttribute('src');
      infoOriginal.innerHTML = '';
      prevConverted.removeAttribute('src');
      infoConverted.innerHTML = '';
      sections.hidden = true;
      drop.hidden = false;
      [...formatGrid.children].forEach(b=>b.classList.remove('active'));
      convertBtn.disabled = true;
      convertBtn.classList.add('btn-muted');
      progress(0,false);
    }

    function progress(val=0, show=false, text=''){
      progressWrap.style.display = show ? 'block' : (val>0 && val<100 ? 'block' : 'none');
      progressBar.style.width = Math.max(0, Math.min(100, val)) + '%';
      if(text) progressText.textContent = text;
    }

    // Core conversion
    async function convertBitmap(bitmap, format, q=0.9){
      // Draw to a canvas
      const canvas = document.createElement('canvas');
      canvas.width = bitmap.width;
      canvas.height = bitmap.height;
      const ctx = canvas.getContext('2d', {alpha: true, willReadFrequently: format==='bmp' || format==='tiff'});
      ctx.drawImage(bitmap, 0, 0);

      if(format === 'bmp'){
        // Pure-JS BMP encoder
        return canvasToBMP(canvas);
      }

      if(format === 'gif'){
        const blob = await encodeGIF(canvas);
        return blob;
      }

      if(format === 'tiff'){
        const blob = await encodeTIFF(canvas);
        return blob;
      }

      // Canvas-native encoders: jpeg, png, webp
      const type = formatToMime(format);
      const quality = LOSSY.has(format) ? q : undefined;
      const blob = await canvasToBlob(canvas, type, quality);
      // Validate true MIME support (no silent PNG fallback)
      if(!blob || !blob.size) throw new Error('Failed to create image blob.');
      if(type && blob.type && type !== 'image/png' && blob.type !== type){
        // The browser ignored requested type; reject instead of faking
        throw new Error(`This browser cannot encode ${FORMAT_LABELS[format]} natively.`);
      }
      return blob;
    }

    // Canvas to Blob as Promise
    function canvasToBlob(canvas, type, quality){
      return new Promise((resolve,reject)=>{
        canvas.toBlob((b)=> b ? resolve(b) : reject(new Error('toBlob failed')), type, quality);
      });
    }

    function readAsDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function fileInfo(name, type, size){
      const kb = Math.round(size/1024);
      return `
        <p><span>Name</span><span>${escapeHtml(name)}</span></p>
        <p><span>Type</span><span>${escapeHtml(type || 'unknown')}</span></p>
        <p><span>Size</span><span>${kb.toLocaleString()} KB</span></p>
      `;
    }

    function getBaseName(name){
      const i = name.lastIndexOf('.');
      return i>0 ? name.slice(0,i) : name;
    }

    function extForMime(mime, fallbackFmt){
      if(!mime) return fallbackFmt || 'img';
      const map = {
        'image/jpeg':'jpg',
        'image/png':'png',
        'image/webp':'webp',
        'image/bmp':'bmp',
        'image/gif':'gif',
        'image/tiff':'tiff'
      };
      return map[mime] || fallbackFmt || 'img';
    }

    function guessMime(fmt){
      return formatToMime(fmt) || 'application/octet-stream';
    }

    function formatToMime(fmt){
      return ({
        jpeg:'image/jpeg',
        png:'image/png',
        webp:'image/webp',
        bmp:'image/bmp',
        gif:'image/gif',
        tiff:'image/tiff'
      })[fmt] || '';
    }

    function escapeHtml(s=''){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // BMP Encoder (24-bit, top-down)
    function canvasToBMP(canvas){
      const w = canvas.width, h = canvas.height;
      const ctx = canvas.getContext('2d');
      const { data:rgba } = ctx.getImageData(0,0,w,h);
      const rowBytes = Math.floor((24 * w + 31) / 32) * 4; // padded row
      const pixelArraySize = rowBytes * h;
      const fileSize = 54 + pixelArraySize;
      const buffer = new ArrayBuffer(fileSize);
      const dv = new DataView(buffer);
      let p = 0;

      // File header 'BM'
      dv.setUint8(p++, 0x42); dv.setUint8(p++, 0x4D);
      dv.setUint32(p, fileSize, true); p+=4;
      dv.setUint16(p, 0, true); p+=2;
      dv.setUint16(p, 0, true); p+=2;
      dv.setUint32(p, 54, true); p+=4;

      // DIB header (BITMAPINFOHEADER)
      dv.setUint32(p, 40, true); p+=4;        // header size
      dv.setInt32(p, w, true); p+=4;          // width
      dv.setInt32(p, -h, true); p+=4;         // negative height => top-down
      dv.setUint16(p, 1, true); p+=2;         // planes
      dv.setUint16(p, 24, true); p+=2;        // bpp
      dv.setUint32(p, 0, true); p+=4;         // compression BI_RGB
      dv.setUint32(p, pixelArraySize, true); p+=4;
      dv.setInt32(p, 2835, true); p+=4;       // x ppm (72dpi)
      dv.setInt32(p, 2835, true); p+=4;       // y ppm
      dv.setUint32(p, 0, true); p+=4;         // colors used
      dv.setUint32(p, 0, true); p+=4;         // important colors

      // Pixels (BGR with row padding)
      let offset = 54;
      const pad = rowBytes - w*3;
      for(let y=0; y<h; y++){
        for(let x=0; x<w; x++){
          const i = (y*w + x) * 4;
          const r = rgba[i], g = rgba[i+1], b = rgba[i+2];
          dv.setUint8(offset++, b);
          dv.setUint8(offset++, g);
          dv.setUint8(offset++, r);
        }
        for(let k=0; k<pad; k++) dv.setUint8(offset++, 0);
      }
      return new Blob([buffer], {type:'image/bmp'});
    }

    // Optional: GIF (single frame) using an external encoder
    async function encodeGIF(canvas){
      // Support either gif.js (window.GIF) or a global GIFEncoder compatible API
      if(window.GIF){
        return new Promise((resolve, reject)=>{
          const gif = new window.GIF({
            workers: 2,
            quality: 10,
            width: canvas.width,
            height: canvas.height,
            workerScript: 'gif.worker.js' // keep the worker next to the script if required by chosen lib
          });
          gif.addFrame(canvas, {copy:true, delay:0});
          gif.on('finished', (blob)=> resolve(blob));
          gif.on('abort', ()=> reject(new Error('GIF encoding aborted')));
          gif.render();
        });
      }else if(window.GIFEncoder){
        // Example for a GIFEncoder API variant that returns binary data
        const ctx = canvas.getContext('2d');
        const { data, width, height } = ctx.getImageData(0,0,canvas.width,canvas.height);
        const enc = new window.GIFEncoder(width, height);
        enc.start(); enc.setRepeat(0); enc.setDelay(0); enc.setQuality(10);
        enc.addFrame(ctx); enc.finish();
        const binary = enc.stream().getData();
        const bytes = new Uint8Array(binary.length);
        for(let i=0;i<binary.length;i++) bytes[i] = binary.charCodeAt(i);
        return new Blob([bytes], {type:'image/gif'});
      }
      throw new Error('GIF encoder not loaded. Please include a browser GIF encoder.');
    }

    // Optional: TIFF via UTIF.encodeImage (baseline, uncompressed)
    async function encodeTIFF(canvas){
      if(!(window.UTIF && window.UTIF.encodeImage)) throw new Error('TIFF encoder not loaded. Please include UTIF with encodeImage().');
      const ctx = canvas.getContext('2d', {willReadFrequently:true});
      const { data, width, height } = ctx.getImageData(0,0,canvas.width,canvas.height);
      // UTIF expects Uint8Array RGBA, returns ArrayBuffer
      const ab = window.UTIF.encodeImage(new Uint8Array(data.buffer), width, height);
      return new Blob([ab], {type:'image/tiff'});
    }
  })();
  </script>
</body>
</html>
